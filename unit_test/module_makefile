# ==========================================
#   Unity Project - A Test Framework for C
#   Copyright (c) 2007 Mike Karlesky, Mark VanderVoord, Greg Williams
#   [Released under MIT License. Please refer to license.txt for details]
# ==========================================

# We try to detect the OS we are running on, and adjust commands as needed
ifeq ($(OS),Windows_NT)
  ifeq ($(shell uname -s),) # not in a bash-like shell
	CLEANUP = del /F /Q
	MKDIR = mkdir
  else # in a bash-like shell, like msys
	CLEANUP = rm -f
	MKDIR = mkdir -p
  endif
	TARGET_EXTENSION=.exe
else
	CLEANUP = rm -f
	MKDIR = mkdir -p
	TARGET_EXTENSION=.out
endif

# We are not generating files called 'clean', 'help', or 'test'
.PHONY: clean
.PHONY: help
.PHONY: test

# The host PC compiler will eventually be configurable
C_COMPILER=gcc

# Specify your default build flags
CFLAGS=-std=c99
CFLAGS += -Wall
CFLAGS += -Wpointer-arith
CFLAGS += -Wcast-align
CFLAGS += -Wwrite-strings
CFLAGS += -Wswitch-default
CFLAGS += -Wunreachable-code
CFLAGS += -Winit-self
CFLAGS += -Wmissing-field-initializers
CFLAGS += -Wno-unknown-pragmas
CFLAGS += -Wundef

# Use some default settings for these variables only if they are not defined
# already by a module's Makefile
PROJ_ROOT ?= ../
SRC_DIR ?= .
UNITY_DIR ?= $(PROJ_ROOT)unit_test/unity
FFF_DIR ?= $(PROJ_ROOT)unit_test/fff
UTEST_DIR ?= unit_testing
TESTS_DIR ?= $(UTEST_DIR)/tests
EXE_DIR ?= $(UTEST_DIR)/exe
RUNNER_DIR ?= $(UTEST_DIR)/runners
RESULTS_DIR ?= $(UTEST_DIR)/results

# Make some mutually-unique lists of our modules sources
# Only files that following the naming convention specified in
# config.ini will be added to these lists
CUT_SRC = $(wildcard $(SRC_DIR)/*.c)
UNITY_SRC = $(wildcard $(UNITY_DIR)/*.c)
TEST_SRC = $(wildcard $(TESTS_DIR)/$(TEST_SRC_PREFIX)*$(TEST_SRC_SUFFIX).c)
RUNNER_SRC = $(wildcard $(RUNNER_DIR)/$(RUNNER_SRC_PREFIX)*$(RUNNER_SRC_SUFFIX).c)

# The executable's file name is generated from the runner source's name
EXECUTABLE = $(patsubst $(RUNNER_DIR)/$(RUNNER_SRC_PREFIX)%$(RUNNER_SRC_SUFFIX).c,$(EXE_DIR)/%$(TARGET_EXTENSION),$(RUNNER_SRC))

# The result's file name is generated from the runner source's name
RESULTS = $(patsubst $(RUNNER_DIR)/$(RUNNER_SRC_PREFIX)%$(RUNNER_SRC_SUFFIX).c,$(RESULTS_DIR)/$(RESULTS_TXT_PREFIX)%$(RESULTS_TXT_SUFFIX).txt,$(RUNNER_SRC))

# Complete list of all source files to be compiled for the build
SRC_FILES = $(CUT_SRC) $(UNITY_SRC) $(TEST_SRC) $(RUNNER_SRC)

# All places to look for headers
INC_DIRS=-I. -I$(UNITY_DIR) -I$(FFF_DIR)

# List of all headers so we can track their existance as dependencies
INC_FILES=\
  $(wildcard $(UNITY_DIR)/%.h) \
  $(wildcard $(FFF_DIR)/%.h) \
  $(wildcard %.h)

# Special #defines desired for the build
SYMBOLS=

# All directories needed for the build
BUILD_DIRS = $(RESULTS_DIR) $(EXE_DIR) $(RUNNER_DIR) $(TESTS_DIR)

# Clean out old results and executable
# Then make sure all necessary directories are in place
# Then run the executable, piping output to our results file
test: clean $(BUILD_DIRS) $(RESULTS)

# After the executable is made, run it and pipe the stdout to the results file
# Return true to keep make from worrying
$(RESULTS): $(EXECUTABLE)
	@-./$< > $@; true

# Compile and link our tet program together using all our resources
# Test suite source and test runner must exist by this time, or the build will fail
$(EXECUTABLE): $(SRC_FILES) $(INC_FILES)
	@$(C_COMPILER) $(CFLAGS) $(INC_DIRS) $(SYMBOLS) $(sort $(SRC_FILES)) -o $(EXECUTABLE)

# Rules to make any module directories that hold generated files
$(EXE_DIR):
	@$(MKDIR) $@

$(RUNNERS_DIR):
	@$(MKDIR) $@

$(RESULTS_DIR):
	@$(MKDIR) $@

# Delete old results file and executable to force compilation of sources under test
clean:
	@$(CLEANUP) $(EXE_DIR)/*$(TARGET_EXTENSION)
	@$(CLEANUP) $(RESULTS_DIR)/*.txt

# Adjust the width of the first column by changing the 30 value in the printf pattern to something larger or smaller
# Remove the | sort to have targets ordered the way they appear in the makefile instead of alphabetically
# Stolen from the internet
help:
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

# Don't delete these files as if they were only intermediate artifacts of the build process
.PRECIOUS: $(EXECUTABLE)
.PRECIOUS: $(RESULTS)
